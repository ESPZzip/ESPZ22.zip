<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ESP:Z COINS - Abrir Cajas Roblox</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; text-align: center; }
    h1 { color: #0f0; }
    .box, .inventory, .balance, .controls, .daily, .updates, .news {
      margin: 20px auto; padding: 15px; border: 1px solid #444;
      border-radius: 10px; background: #222; max-width: 600px;
    }
    button { padding: 6px 12px; margin: 3px; border: none;
      border-radius: 5px; background: #0f0; color: #000;
      font-weight: bold; cursor: pointer; font-size: 14px; }
    button:hover { background: #6f6; }
    ul { list-style: none; padding: 0; }
    li { margin: 5px 0; display: flex; justify-content: space-between; align-items: center; }
    #countdown, #box-countdown { font-weight: bold; color: #0f0; }
    .sell-btn { background: #f33; color: #fff; font-size: 12px; padding: 4px 8px; }
    .sell-btn:hover { background: #f66; }
  </style>
</head>
<body>
  <h1>ESP:Z COINS - Cajas Roblox</h1>

  <div class="balance">
    <h2>Monedas: <span id="coins">0</span> ESP:Z</h2>
  </div>

  <div class="daily">
    <h2>Recompensa diaria</h2>
    <p id="daily-status">Revisando...</p>
    <p>Siguiente recompensa en: <span id="countdown">--:--:--</span></p>
  </div>

  <div class="updates">
    <h2>Actualización de cajas</h2>
    <p>Próximos ítems en: <span id="box-countdown">--:--</span></p>
  </div>

  <div class="news">
    <h2>Últimos ítems agregados</h2>
    <ul id="news-list"></ul>
  </div>

  <div class="controls">
    <button onclick="openBox('basica')">Abrir Caja Básica (150)</button>
    <button onclick="openBox('epica')">Abrir Caja Épica (1200)</button>
    <button onclick="sellAll()">Vender Todo</button>
    <button onclick="resetGame()">Reiniciar</button>
  </div>

  <div class="inventory">
    <h2>Inventario</h2>
    <ul id="inventory"></ul>
  </div>

  <script>
    let BOXES = {
      basica: {
        price: 150,
        items: [
          { name: "Robux Coin", value: 100, prob: 0.5 },
          { name: "Noob Character", value: 150, prob: 0.3 },
          { name: "Roblox Shirt", value: 200, prob: 0.15 },
          { name: "Roblox Hat", value: 300, prob: 0.05 }
        ]
      },
      epica: {
        price: 1200,
        items: [
          { name: "Epic Roblox Sword", value: 800, prob: 0.4 },
          { name: "Golden Robux", value: 1000, prob: 0.3 },
          { name: "Red Valkyrie", value: 1200, prob: 0.2 },
          { name: "Dominus", value: 1500, prob: 0.1 }
        ]
      }
    };

    const EXTRA_ITEMS = [
      { name: "Rainbow Dominus", value: 2000, prob: 0.05 },
      { name: "Ban Hammer", value: 1800, prob: 0.1 },
      { name: "Roblox Fedora", value: 900, prob: 0.3 },
      { name: "Builder’s Hat", value: 700, prob: 0.35 },
      { name: "Bloxy Award", value: 2200, prob: 0.2 }
    ];

    let coins = 0;
    let inventory = [];
    let lastClaim = null;
    let newsList = [];

    let nextBoxUpdate;
    let temporaryItems = [];

    function saveGame() {
      localStorage.setItem("coins", coins);
      localStorage.setItem("inventory", JSON.stringify(inventory));
      localStorage.setItem("lastClaim", lastClaim);
      localStorage.setItem("nextBoxUpdate", nextBoxUpdate);
      localStorage.setItem("newsList", JSON.stringify(newsList));
      localStorage.setItem("temporaryItems", JSON.stringify(temporaryItems));
    }

    function loadGame() {
      coins = parseInt(localStorage.getItem("coins")) || 0;
      inventory = JSON.parse(localStorage.getItem("inventory")) || [];
      lastClaim = localStorage.getItem("lastClaim") || null;
      newsList = JSON.parse(localStorage.getItem("newsList")) || [];
      temporaryItems = JSON.parse(localStorage.getItem("temporaryItems")) || [];

      const storedUpdate = parseInt(localStorage.getItem("nextBoxUpdate"));
      if (storedUpdate && storedUpdate > Date.now()) {
        nextBoxUpdate = storedUpdate;
      } else {
        nextBoxUpdate = Date.now() + (20 * 60 * 1000);
      }

      cleanupExpiredItems();
      updateUI();
    }

    function updateUI() {
      document.getElementById("coins").innerText = coins;
      const inv = document.getElementById("inventory");
      inv.innerHTML = "";
      inventory.forEach((item, index) => {
        const li = document.createElement("li");
        li.innerHTML = `${item.name} (Vale ${item.value}) <button class='sell-btn' onclick='sellItem(${index})'>Vender</button>`;
        inv.appendChild(li);
      });

      const news = document.getElementById("news-list");
      news.innerHTML = "";
      newsList.slice(-5).reverse().forEach((entry) => {
        const li = document.createElement("li");
        li.textContent = entry;
        news.appendChild(li);
      });
    }

    function weightedRandom(items) {
      let totalProb = items.reduce((sum, it) => sum + it.prob, 0);
      let r = Math.random() * totalProb;
      let acc = 0;
      for (let it of items) {
        acc += it.prob;
        if (r <= acc) return it;
      }
      return items[items.length - 1];
    }

    function openBox(type) {
      const box = BOXES[type];
      if (coins < box.price) {
        alert("No tienes suficientes monedas");
        return;
      }
      coins -= box.price;
      const reward = weightedRandom(box.items);
      inventory.push(reward);
      alert(`Has obtenido: ${reward.name} (Vale ${reward.value})`);
      saveGame();
      updateUI();
    }

    function sellItem(index) {
      const item = inventory[index];
      if (confirm(`¿Seguro que quieres vender ${item.name} por ${item.value} monedas?`)) {
        coins += item.value;
        inventory.splice(index, 1);
        saveGame();
        updateUI();
      }
    }

    function sellAll() {
      let total = inventory.reduce((sum, item) => sum + item.value, 0);
      coins += total;
      inventory = [];
      alert(`Has vendido todo por ${total} monedas.`);
      saveGame();
      updateUI();
    }

    function resetGame() {
      if (confirm("¿Seguro que quieres reiniciar tu progreso?")) {
        coins = 0;
        inventory = [];
        lastClaim = null;
        newsList = [];
        temporaryItems = [];
        nextBoxUpdate = Date.now() + (20 * 60 * 1000);
        saveGame();
        updateUI();
      }
    }

    // Recompensa diaria
    function checkDailyReward() {
      const now = new Date();
      const today = now.toDateString();
      if (lastClaim !== today) {
        coins += 2500;
        lastClaim = today;
        document.getElementById("daily-status").innerText = "¡Has recibido 2500 monedas hoy!";
        alert("¡Has recibido 2500 monedas diarias!");
        saveGame();
        updateUI();
      } else {
        document.getElementById("daily-status").innerText = "Ya reclamaste tu recompensa hoy.";
      }
      updateCountdown();
    }

    function updateCountdown() {
      const now = new Date();
      const tomorrow = new Date();
      tomorrow.setHours(24, 0, 0, 0);
      let diff = Math.max(0, tomorrow - now);

      let hours = Math.floor(diff / (1000 * 60 * 60));
      let minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      let seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById("countdown").innerText =
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      if (diff <= 0) {
        checkDailyReward();
      }
    }

    // Ítems temporales
    function cleanupExpiredItems() {
      const now = Date.now();
      temporaryItems = temporaryItems.filter(ti => {
        if (ti.expires > now) return true;
        let box = BOXES[ti.box];
        box.items = box.items.filter(it => it.name !== ti.item.name);
        const exclusiveItem = { name: `[EXCLUSIVO] ${ti.item.name}`, value: ti.item.value * 2, prob: 0 };
        inventory.push(exclusiveItem);
        alert(`El ítem ${ti.item.name} ha expirado de ${ti.box} y fue guardado en tu inventario como exclusivo.`);
        newsList.push(`El ítem ${ti.item.name} expiró de ${ti.box} y fue guardado en el inventario como exclusivo.`);
        return false;
      });
      saveGame();
    }

    // Actualización de cajas
    function updateBoxItems() {
      const randomItem = weightedRandom(EXTRA_ITEMS);
      let boxName, boxKey;
      if (Math.random() > 0.5) {
        BOXES.basica.items.push(randomItem);
        boxName = "Caja Básica";
        boxKey = "basica";
      } else {
        BOXES.epica.items.push(randomItem);
        boxName = "Caja Épica";
        boxKey = "epica";
      }
      const msg = `¡Nuevo ítem agregado a ${boxName}: ${randomItem.name} (Vale ${randomItem.value})!`;
      newsList.push(msg);
      alert(msg);

      temporaryItems.push({
        item: randomItem,
        box: boxKey,
        expires: Date.now() + (60 * 60 * 1000)
      });

      nextBoxUpdate = Date.now() + (20 * 60 * 1000);
      saveGame();
      updateUI();
    }

    function updateBoxCountdown() {
      cleanupExpiredItems();
      let diff = Math.max(0, nextBoxUpdate - Date.now());
      let minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      let seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById("box-countdown").innerText =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      if (diff <= 0) {
        updateBoxItems();
      }
    }

    setInterval(updateCountdown, 1000);
    setInterval(updateBoxCountdown, 1000);

    loadGame();
    checkDailyReward();
  </script>
</body>
</html>
