<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mini Roblox - Marketplace Global</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; }
    header { background:#24292e; color:#fff; padding:10px; display:flex; justify-content:space-between; }
    #userInfo { font-weight:bold; }
    nav { background:#444; padding:10px; display:flex; gap:10px; }
    nav button { padding:8px 12px; border:none; cursor:pointer; border-radius:5px; }
    .tab { display:none; padding:20px; }
    .item { background:#fff; padding:10px; margin:10px; border-radius:8px; display:inline-block; width:150px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
    .item img { max-width:100%; border-radius:5px; }
    #login, #register { background:#fff; padding:20px; max-width:300px; margin:50px auto; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
    input, button { margin:5px 0; padding:8px; width:100%; }
  </style>
</head>
<body>

<header>
  <div id="userInfo">No conectado</div>
  <div id="robuxInfo">R$: 0</div>
</header>

<div id="auth">
  <div id="register">
    <h2>Registrarse</h2>
    <input type="text" id="regUser" placeholder="Usuario">
    <input type="password" id="regPass" placeholder="Contrase침a">
    <button onclick="register()">Registrarse</button>
  </div>
  <div id="login">
    <h2>Iniciar Sesi칩n</h2>
    <input type="text" id="logUser" placeholder="Usuario">
    <input type="password" id="logPass" placeholder="Contrase침a">
    <button onclick="login()">Iniciar Sesi칩n</button>
  </div>
</div>

<div id="app" style="display:none;">
  <nav>
    <button onclick="showTab('market')">Marketplace</button>
    <button onclick="showTab('inventory')">Inventario</button>
  </nav>

  <div id="market" class="tab">
    <h2>Marketplace Global</h2>
    <div id="marketItems"></div>
  </div>

  <div id="inventory" class="tab">
    <h2>Mi Inventario</h2>
    <div id="myItems"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // 游뚿 PON AQU칈 TU CONFIG DE FIREBASE 游뚿
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_PROYECTO.firebaseapp.com",
    projectId: "TU_PROYECTO",
    storageBucket: "TU_PROYECTO.appspot.com",
    messagingSenderId: "ID",
    appId: "APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentUser = null;

  // ---------- Registro ----------
  async function register() {
    let user = document.getElementById("regUser").value;
    let pass = document.getElementById("regPass").value;

    let userRef = doc(db, "users", user);
    let docSnap = await getDoc(userRef);
    if (docSnap.exists()) {
      alert("Usuario ya existe");
      return;
    }

    await setDoc(userRef, {
      password: pass,
      robux: 100,
      inventory: []
    });

    alert("Registrado, ahora inicia sesi칩n");
  }

  // ---------- Login ----------
  async function login() {
    let user = document.getElementById("logUser").value;
    let pass = document.getElementById("logPass").value;

    let userRef = doc(db, "users", user);
    let docSnap = await getDoc(userRef);
    if (!docSnap.exists()) {
      alert("No existe usuario");
      return;
    }
    if (docSnap.data().password !== pass) {
      alert("Contrase침a incorrecta");
      return;
    }

    currentUser = user;
    document.getElementById("auth").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("userInfo").innerText = "Usuario: " + currentUser;
    updateRobux();
    showTab("market");
    loadInventory();
  }

  // ---------- Marketplace Global ----------
  const marketDiv = document.getElementById("marketItems");
  onSnapshot(collection(db, "marketplace"), snapshot => {
    marketDiv.innerHTML = "";
    snapshot.forEach(docSnap => {
      let item = docSnap.data();
      marketDiv.innerHTML += `
        <div class="item">
          <img src="${item.img}">
          <h3>${item.name}</h3>
          <p>Precio: ${item.price} R$</p>
          <p>Stock: ${item.stock}</p>
          <button onclick="buyItem('${docSnap.id}', ${item.price})">Comprar</button>
        </div>
      `;
    });
  });

  // ---------- Comprar Item ----------
  async function buyItem(itemId, price) {
    if (!currentUser) { alert("Inicia sesi칩n"); return; }

    let userRef = doc(db, "users", currentUser);
    let userSnap = await getDoc(userRef);
    let userData = userSnap.data();

    if (userData.robux < price) {
      alert("Robux insuficientes");
      return;
    }

    let itemRef = doc(db, "marketplace", itemId);
    let itemSnap = await getDoc(itemRef);
    let item = itemSnap.data();

    if (item.stock <= 0) {
      alert("Sin stock");
      return;
    }

    // Actualizar stock e inventario
    await updateDoc(itemRef, { stock: item.stock - 1 });
    await updateDoc(userRef, {
      robux: userData.robux - price,
      inventory: [...userData.inventory, item.name]
    });

    updateRobux();
    loadInventory();
    alert("춰Comprado y a침adido a tu inventario!");
  }

  // ---------- Mostrar Robux ----------
  async function updateRobux() {
    if (!currentUser) return;
    let userRef = doc(db, "users", currentUser);
    let snap = await getDoc(userRef);
    document.getElementById("robuxInfo").innerText = "R$: " + snap.data().robux;
  }

  // ---------- Inventario ----------
  async function loadInventory() {
    let userRef = doc(db, "users", currentUser);
    let snap = await getDoc(userRef);
    let items = snap.data().inventory || [];
    let invDiv = document.getElementById("myItems");
    invDiv.innerHTML = items.map(i => `<div class="item"><h4>${i}</h4></div>`).join("");
  }

  // ---------- Tabs ----------
  function showTab(tab) {
    document.querySelectorAll(".tab").forEach(t => t.style.display = "none");
    document.getElementById(tab).style.display = "block";
  }
</script>
</body>
</html>
